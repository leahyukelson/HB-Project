{% extends 'base.html' %}
{% block content %}

<style type="text/css">

  .options {
    display: inline-block;
}
    
    .google-map {
      vertical-align: right;
      height: 100px;
    }


</style>

{% if (upcoming) or (past) %}
<a href="/new-plan" class="btn btn-primary">Create New</a>
<br><br>
<div class="chartCollapseContainer">
  <button type="button" id="chart-btn" class="btn btn-info" data-toggle="collapse" data-target="#event-jchart">Collapse Chart</button>
</div>
<div id="event-jchart" class="event-chart collapse in">
  <canvas id="lineChart" width="40" height="20"></canvas>
  <div id="lineLegend" class="chart-legend"></div>
      </div>

<h2>Plans</h2>
<ul class="nav nav-tabs">
  <li class="active"><a data-toggle="tab" href="#upcoming">Upcoming</a></li>
  <li><a data-toggle="tab" href="#past">Past</a></li>
</ul>

<div class="tab-content">
  <div id="upcoming" class="tab-pane fade in active">
  {% for plan in upcoming %}
  <div class="upcoming-plan">
      <h3>{{ plan.event_time.strftime('%x')}} {{plan.plan_name }}</h3>
      {% if (plan.food_name) and (plan.food_time) %}
      <h4>{{ plan.food_time.strftime('%-I:%M %p')}}: {{plan.food_name}}</h4>
        <p class="bus-address">{{plan.food_address}}</p>
        <p class="bus-address2">{{plan.food_city}}, {{plan.food_state}} {{plan.food_zipcode}}</p>
        <p class="plan-id" hidden>{{plan.plan_id}}</p>
        <p class="food-longitude" hidden>{{plan.food_longitude}}</p>
        <p class="food-latitude" hidden>{{plan.food_latitude}}</p>  
      {% endif %}
      <h4>{{plan.event_time.strftime('%-I:%M %p') }}: {{plan.event_name}}</h4>
        {% if plan.event_location %}
        <p>{{plan.event_location}}</p>
        {% endif %}
        <p class="plan-address">{{plan.event_address}}</p>
        <p class="plan-address2">{{plan.event_city}}, {{plan.event_state}} {{plan.event_zipcode}}
      {% if plan.invitees %}
      <h4>Friends Invited:</h4>
      {% endif %}
      {% for invitees in plan.invitees %}
        {% if not invitees.email == session['current_user']  %}
        <p>{{invitees.first_name}} {{invitees.last_name}}</p>
      {% endif %}
      {% endfor %}
      {% if plan.invitees|length == 1 %}
        {% if plan.invitees[0].email == session['current_user'] %}
        <p>Just you!</p>
        {% endif %}
      {% endif %}
      {% if plan.plan_user_creator == current_user %}
    <div class="dropdown options">
      <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Edit Plan
      <span class="caret"></span></button>
      <ul class="dropdown-menu">
        <li><a href="/edit-plan/{{plan.plan_id}}">Edit Event</a></li>
        <li><a href="/choose-restaurant/{{plan.plan_id}}">Edit Restaurant/ Bar</a></li>
        <li><a href="/add-more-friends/{{plan.plan_id}}">Add Friends</a></li>
      </ul>
      </div>
    <a href="/delete-plan/{{plan.plan_id}}" class="btn btn-danger">Delete Plan</a>
      {% endif %}
    <button class="btn btn-warning decline_plan_btn" value="/decline-plan/{{plan.plan_id}}">Decline Plan</button>
    <div class="google-map" id="map{{plan.plan_id}}"></div>
    </div>
  {% endfor %}
  </div>

  <div id="past" class="tab-pane fade">
  {% for plan in past %}
      <h3>{{ plan.event_time.strftime('%x')}} {{plan.plan_name }}</h3>
      {% if (plan.food_name) and (plan.food_time) %}
      <h4>{{ plan.food_time.strftime('%-I:%M %p')}}: {{plan.food_name}}</h4>
        <p>{{plan.food_address}}</p>
        <p>{{plan.food_city}}, {{plan.food_state}} {{plan.food_zipcode}}</p>  
      {% endif %}
      <h4>{{plan.event_time.strftime('%-I:%M %p') }}: {{plan.event_name}}</h4>
        {% if plan.event_location %}
        <p>{{plan.event_location}}</p>
        {% endif %}
        <p>{{plan.event_address}}</p>
        <p>{{plan.event_city}}, {{plan.event_state}} {{plan.event_zipcode}}
      {% if plan.invitees %}
      <h4>Friends Invited:</h4>
      {% endif %}
      {% for invitees in plan.invitees %}
        {% if not invitees.email == session['current_user']  %}
        <p>{{invitees.first_name}} {{invitees.last_name}}</p>
      {% endif %}
      {% endfor %}
  {% endfor %}
  </div>
</div>

{% else %}
<a href="/new-plan">You have no plans yet. Create one now!</a>
{% endif %}


<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.2.1/Chart.js"></script>

<script>
"use strict";
var options = {
      responsive: true
    };

// Make Line Chart of event frequency by month
var ctx_line = $("#lineChart").get(0).getContext("2d");

$.get("/event-frequency.json", function (data) {
      var myLineChart = Chart.Line(ctx_line, {
                                    data: data,
                                    options: options
                                });
});

var decline_url;

function decline_plan(evt) {
  evt.preventDefault();

  if (confirm("Are you sure you would no longer like to attend this plan?") == true) {
      decline_url = this.value;
      console.log(decline_url);
      $.post(decline_url, {});
      alert("This plan is no longer in your profile");
  }
}

$(".decline_plan_btn").on("click", decline_plan);

$(document).ready(function(){
  $("#event-jchart").on("hide.bs.collapse", function(){
    $("#chart-btn").html("Show Chart");
  });
  $("#event-jchart").on("show.bs.collapse", function(){
    $("#chart-btn").html("Collapse Chart");
  });
});

function initMap(){
   $(".upcoming-plan").each(function() {
      console.log($(this));
      var plan_id = $(this).children(".plan-id").html();
      var food_latitude = parseFloat($(this).children(".food-latitude").html());
      var food_longitude = parseFloat($(this).children(".food-longitude").html());
      var ltLng = {lat: food_latitude, lng: food_longitude};
      console.log(plan_id);
      console.log(food_latitude);
      var map = new google.maps.Map(document.getElementById("map"+plan_id), {
        zoom: 5,
        center: ltLng
      });
    }
      );
}



</script>
<script type="text/javascript">
  function initialize(){
  $(document).ready(initMap());
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4vEycjJ1g4LUHzhfZfi0qAfMlWt3jRX8&libraries=places&callback=initialize"
        async defer></script>

{% endblock %}